<!doctype html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <title>Door Bot | kalmas.net</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width,minimum-scale=1">

  <link href="https://fonts.googleapis.com/css?family=Cinzel|Ubuntu+Mono|Lora" rel="stylesheet">

  <link rel="stylesheet" href="https://kalmas.net/css/reset.css">
  <link rel="stylesheet" href="https://kalmas.net/css/style.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/hopscotch.min.css" />
</head>
<body>

<section class="section">
  <div class="container">
    <nav class="margin-bottom-lg">
      <h1 class="site-title mono"><a class="no-dec" href="https://kalmas.net">kalmas.net</a></h1>
      <ul id="links">
        <li><a class="mono" href="/blog">Blog</a></li>
        <li><a class="mono" href="https://github.com/kalmas">GitHub</a></li>
        <li><a class="mono" href="https://github.com/kalmas/resume">Resume</a></li>
      </ul>
    </nav>
  </div>
</section>

<section class="section margin-bottom-xlg">
  <div class="container">
    <h2 class="size-medium grey">November 25, 2014</h2>
    <h1>Door Bot</h1>
    <div class="content">
      <div class="paragraph">
<p>For a good long while (2 whole years according to Github commits ðŸ˜©), my buddy Cody and I have been hacking on an automatic door lock for the front door of his house. We&#8217;ve gone through a handful of iterations and dead-ends (the most painful of which involved attempting to write a REST webservice for the Arduino Ethernet Shield), but a few days ago we finally finished. I&#8217;m ready to put this project to bed and move on to building <strong>real</strong> robots (the walking, talking, terminating kind). So to wrap things up, here&#8217;s a blog post&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><a href="https://www.instagram.com/p/vcaZWJMZc4/">But first an adorable video!</a></p>
</div>
<div class="sect1">
<h2 id="_version_0">Version 0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To explain our project, I&#8217;ll begin with the first iteration of what I will refer to, lovingly, as DoorBot (â„¢ pending). The first DoorBot was something Cody hacked together over a few days: an <a href="http://arduino.cc/en/Main/arduinoBoardUno">Arduino Uno</a> connected to a <a href="http://www.amazon.com/Black-Plastic-Weigand-Proximity-Reader/dp/B00AUB2RQ4/ref=sr_1_3?ie=UTF8&amp;qid=1416784413">Arduino Uno</a> and a <a href="http://www.amazon.com/Generic-Secure-Electric-Strike-Control/dp/B00JWDE98K/ref=sr_1_4?s=electronics&amp;ie=UTF8&amp;qid=1416784606">resting closed electric door lock</a>.</p>
</div>
<div class="paragraph">
<p>It worked like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A RFID card is swiped past the card reader.</p>
</li>
<li>
<p>The Arduino receives a string of bytes containing the card&#8217;s passcode.</p>
</li>
<li>
<p>If the code is found in a hardcoded list, a pin on the Arduino is turned on for 2 seconds, opening the electric lock.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The code wasn&#8217;t pretty and the wiring was slapdash (Cody pointed out that the 2 second open time was convenient because a duration much longer would present a risk of fire), but it worked, reliably and without maintenance, for over two years.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_if_it_ain_t_broke_fix_it">If It Ain&#8217;t Broke, Fix It</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I decided a necessary enhancement was connecting DoorBot to the Internet. Half of my motivation was to use the project as a learning exercise to better understand the path from solenoid to HTTP. The other half was a desire to bring the logic up to a level where I could use my skill set; several days of compiling <a href="http://arduino.cc/en/Reference/HomePage">weird code</a> to run inside a <a href="http://stackoverflow.com/questions/7225693/how-do-you-debug-arduino-code-running-on-arduino-hardware">black box of un-debuggable-ness</a> had me feeling pretty unproductive.</p>
</div>
<div class="paragraph">
<p>Cody and I planned to build a simple website that could be used to remotely open the lock. This would be a good learning experience for both of us, and would satisfy the real world use cases of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Opening the door without a card (or key).</p>
</li>
<li>
<p>Opening the door for someone without going downstairs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Should be pretty simple I thought. We would be done in a week.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_version_1_2_years_later">Version 1 (2 Years Later)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our latest, working, iteration was completed on November 6th (I almost finished this blog post the same week&#8230;&#8203; alas). It provides the same RFID card reading functionality as Version 0, and adds a one button website to open the door. To accomplish this we ended up adding a <a href="http://www.amazon.com/Raspberry-Pi-Model-512MB-Computer/dp/B00LPESRUK">Raspberry Pi</a> to the DoorBot. Leaving us with an <strong>only slightly</strong> overkill design.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/img/door-bot.png" alt="Door Bot Diagram"></span></p>
</div>
<div class="paragraph">
<p>The web portion of the system works like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Pi serves a website over Wi-Fi.</p>
</li>
<li>
<p>When the button is clicked, an open signal is sent over USB to the Arduino.</p>
</li>
<li>
<p>A signal interrupts the main RFID card reading loop and opens the lock.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_on_the_arduino">On The Arduino</h3>
<div class="paragraph">
<p>The code on the Arduino runs a continuous loop that does 2 things.</p>
</div>
<div class="paragraph">
<p>First, it checks the RFID sensor for input, reads that input a valid passcode, and maybe opens the door.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">/**
 * Read from RFID
 */
if (mySerial.available()) {

    Serial.write("Incoming\n");
    while(tagIndex &lt; 13) {
        if (mySerial.available()) {
            int readByte = mySerial.read();

            if (readByte != 2 &amp;&amp; readByte != 10 &amp;&amp; readByte != 13) {
                tagString[tagIndex] = readByte;
                tagIndex = tagIndex + 1;
            }
        }
    }

    Serial.write("Tag: ");
    Serial.write(tagString);
    Serial.write("\n");

    if (isAllowed(tagString)) {
        Serial.write("Open Sesame!");
        digitalWrite(lockPin, HIGH);
        delay(2000);
        digitalWrite(lockPin, LOW);
    } else {
        Serial.write("Sry, Not Allowed :(");
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Second, it listens for an "open" signal sent from the Raspberry Pi.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">/**
 * Control lock
 */
if (Serial.available()) {
    int incomingByte = Serial.read();

    if (incomingByte == 0x01) {
        digitalWrite(lockPin, HIGH);
    } else if (incomingByte == 0x00) {
        digitalWrite(lockPin, LOW);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One complication that we ran into was this: by default the Arduino uses the a specific pin (pin 1, I think?) to read serial input using its built in <a href="http://arduino.cc/en/reference/serial">Serial</a> library, but Serial is also listening to the USB port for input. This means that if you want communication over USB, you can&#8217;t use Serial to read from the default serial pin at the same time; the streams cross and nothing works. The workaround comes in the form of the <a href="http://arduino.cc/en/Reference/softwareSerial">SoftwareSerial</a> library which allows you to reproduce the functionality of Serial using an arbitrary input and output pin. This is why in the code above there are references to both mySerial (connected to the RFID reader) and Serial (connected to the Pi). You can see how these two references are initialized along with the rest of the script here: <a href="https://github.com/kalmas/web-door/blob/master/micro_door/micro_door.ino" class="bare">https://github.com/kalmas/web-door/blob/master/micro_door/micro_door.ino</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_the_pi">On The Pi</h3>
<div class="paragraph">
<p>The Pi is responsible for serving the website. We brought the Pi into the mix after realizing that coding an HTTP interface for the Arduino is a job for masochists. In contrast, on the Pi we can just write a few lines of JavaScript and call it a day. Case in point, here&#8217;s most of the application code required to pass web requests through to the Arduino.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var usb = '/dev/ttyACM0';

var express = require('express');
var router = express.Router();
var serialport = require('serialport');
var SerialPort = serialport.SerialPort;
var serial = new SerialPort(usb, {
    baudrate: 9600,
    parser: serialport.parsers.readline("\n")
});

// Close the lock.
var close = function() {
    serial.write(new Buffer([0x00]));
};

// Open the lock.
var open = function() {
    serial.write(new Buffer([0x01]));
};

router.get('/', function(req, res) {
    res.render('index', { title: 'Who Dat?' });
});

// Open the lock then close it 2 seconds later.
router.post('/open', function(req, res) {
    res.send();
    open();
    setTimeout(close, 2000);
});

module.exports = router;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The heavy lifting here is done by <a href="https://github.com/strongloop/expressjs.com">express</a> and <a href="https://github.com/voodootikigod/node-serialport">node-serialport</a>. node-serialport is pretty slick and I can&#8217;t wait to use it for future robotics projects. Just provide it a USB port address and a baud rate and you&#8217;re ready to talk to any piece of hardware.</p>
</div>
<div class="paragraph">
<p>To get the Pi connected to the network we installed an <a href="http://www.amazon.com/Edimax-EW-7811Un-150Mbps-Raspberry-Supports/dp/B003MTTJOY/ref=pd_bxgy_pc_img_y">outrageously cheap USB Wi-Fi dongle</a> using these easy setup instructions <a href="http://kerneldriver.wordpress.com/2012/10/21/configuring-wpa2-using-wpa_supplicant-on-the-raspberry-pi/" class="bare">http://kerneldriver.wordpress.com/2012/10/21/configuring-wpa2-using-wpa_supplicant-on-the-raspberry-pi/</a>.</p>
</div>
<div class="paragraph">
<p>To make the server run as a service on boot, we added to the <code>/etc/rc.local.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">su web -c '/bin/sh /home/pi/web-door/node-door/start.sh &lt; /dev/null &amp;'</code></pre>
</div>
</div>
<div class="paragraph">
<p>And made a <code>start.sh</code> to start the node server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">#!/bin/bash

/usr/bin/sudo /usr/local/bin/node /home/pi/web-door/node-door/app.js</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_finished_product">Finished Product</h3>
<div class="paragraph">
<p>The final product works remarkably well. Connecting to the network and pulling up the website is easily done on the way up the driveway. I&#8217;ve encounted a few unexplained server outages, but in these cases I can just fall back to using my RFID card (which always works like a champ). This is my first experience writing code that makes stuff physically move, and it really makes me feel like a magician.</p>
</div>
<div class="paragraph">
<p>See the full code <a href="https://github.com/kalmas/web-door">here</a>. See the door itself on the front of Cody&#8217;s house.</p>
</div>
</div>
</div>
</div>

    </div>
  </div>
</section>
<section class="section">
  <div class="container has-text-centered">
    <p></p>
  </div>
</section>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
