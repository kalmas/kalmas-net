<!doctype html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <title>Dependency Injection 101 | kalmas.net</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width,minimum-scale=1">

  <link href="https://fonts.googleapis.com/css?family=Cinzel|Ubuntu+Mono|Lora" rel="stylesheet">

  <link rel="stylesheet" href="https://kalmas.net/css/reset.css">
  <link rel="stylesheet" href="https://kalmas.net/css/style.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/hopscotch.min.css" />
</head>
<body>

<section class="section">
  <div class="container">
    <nav class="margin-bottom-lg">
      <h1 class="site-title mono"><a class="no-dec" href="https://kalmas.net">kalmas.net</a></h1>
      <ul id="links">
        <li><a class="mono" href="/blog">Blog</a></li>
        <li><a class="mono" href="https://github.com/kalmas">GitHub</a></li>
        <li><a class="mono" href="https://github.com/kalmas/resume">Resume</a></li>
      </ul>
    </nav>
  </div>
</section>

<section class="section margin-bottom-xlg">
  <div class="container">
    <h2 class="size-medium grey">January 14, 2014</h2>
    <h1>Dependency Injection 101</h1>
    <div class="content">
      <div class="paragraph">
<p>Dependency injection is an incredible thing. Practicing it in your programming will make your code more reusable, readable, and, most importantly, testable.</p>
</div>
<div class="paragraph">
<p>I read a quote the other day that I loved from Michael Feathers' Working Effectively with Legacy Code, "Legacy code is simply code without tests".</p>
</div>
<div class="paragraph">
<p>If you&#8217;re not injecting your dependencies, you&#8217;re not going to be able to test your code (or at least not test it in a sane way). It follows that if you&#8217;re not injecting your dependencies, you&#8217;re writing legacy code, and you don&#8217;t want to be that guy, because you hate that guy and he makes your life miserable.</p>
</div>
<div class="paragraph">
<p>But I&#8217;m already ahead of myself. This is a 101 level course so let&#8217;s start with the obvious: What is dependency injection? It&#8217;s a programming pattern that aims to separate the responsibility of locating a resource from the class (or module) that uses it. Another term for this pattern is "inversion of control." If we don&#8217;t want a class looking up a resource (dependency) itself, then we&#8217;ll need to pass it (inject) the resource we would like for it to use. Hence, "dependency injection."</p>
</div>
<div class="paragraph">
<p>Of course, showing is better than telling, so let&#8217;s build out an example:</p>
</div>
<div class="sect1">
<h2 id="_1_a_simple_script">1. A Simple Script</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll start with a simple script that models the bridge of a Starfleet vessel. You can grab the code yourself from Github.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh"># Fetch example code
git clone https://github.com/kalmas/DI-101.git
cd DI-101
git checkout -f step1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running <code>php example.php</code> will echo out a command from our captain.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">$kirk = new Captain();
echo $kirk-&gt;issueCommand() . "\n";</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s assume that our <code>issueCommand()</code> method needs to log some information while it is running. Printing to the console meets our needs for right now. What&#8217;s the fastest way to change our code to do this? The following would work.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">public function issueCommand() {
	echo "Captain's Log, Stardate {$this-&gt;getStardate()}: {$this-&gt;getEntry()}\n";
	return $this-&gt;getCommand();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now on the console you should get something like the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-txt" data-lang="txt">Captain's Log, Stardate 2456668.5984375: The Enterprise remains in standard orbit while we investigate the tragedy which has struck the away team. Lieutenant Marla Aster, ship's archaeologist, has been killed on what should have been a routine mission. Whatever the explanation, it will not bring back a valued and trusted officer.
Make it so.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Later, we decide we would prefer that the function log to a text file named "captains.log." Easy enough, just hack out that echo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">public function issueCommand() {
	file_put_contents('captains.log',
		"Captain's Log, Stardate {$this-&gt;getStardate()}: {$this-&gt;getEntry()}\n", FILE_APPEND);
	return $this-&gt;getCommand();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even later, we decide that our application will need two captains, each one with different logging requirements. One captain will log to the console, while the other will write to a text file. One way we could meet this requirement is by making two different captain classes, but this of course would introduce duplicate code (something we would prefer to avoid). We could limit the amount of duplicate code by making the two types of captain that extend a single <code>Captain</code> base class, but dependency injection gives us a cleaner solution.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2_injecting_dependencies">2. Injecting Dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Both implementations of <code>Captain</code> depend on a logging resource, and both use that resource in a similar way, so lets inject that resource into the <code>Captain</code> class. Our first step is to wrap both resources into classes with a common method, so we have created <code>Example\Log\Console</code> and <code>Example\Log\File</code>, both of which have a <code>println()</code> method that will handle writing our output. Like a good cooking show host, I&#8217;ve got the oven preheated and the gravy ready for the flavor injector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh"># Switch to version of code with some log classes added, dependencies ready for injection
git checkout -f step2</code></pre>
</div>
</div>
<div class="paragraph">
<p>To allow <code>Captain</code> to use one of these classes we will add a constructor that allows us to assign <code>Captain</code> a <code>$captainsLog</code> property on instantiation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">class Captain {
	private $captainsLog;
	public function __construct($log){
		$this-&gt;captainsLog = $log;
	}
	...</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use the log we add a call to <code>println()</code> (common to both log implementations) to <code>issueCommand()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">public function issueCommand() {
	$this-&gt;captainsLog-&gt;println("Captain's Log, {$this-&gt;getStardate()}", true);
	$this-&gt;captainsLog-&gt;println($this-&gt;getEntry());

	return $this-&gt;getCommand();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now all we need to do to make 2 (or 20) captains with different logging preferences is to instantiate each with the appropriate log class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">$kirk = new Captain(new Console());
$picard = new Captain(new File());</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_defining_an_interface">3. Defining an Interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dynamic languages like PHP make dependency injection a trivial task; as long as the object we inject has the method(s) that we&#8217;re going to call attached to it, the code will run. PHP doesn&#8217;t care what class my injected object belongs to as long as it can perform the tasks requested (see: <a href="http://en.wikipedia.org/wiki/Duck_typing">Duck Typing</a>). However, while this freedom from inheritance makes for quick examples and prototypes, adding some rules around how an injected object will behave will help make our code more maintainable in the long run. To add these rules we will use an interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh"># Switch to version of code with generic dependencies injected, ready to add an interface
git checkout -f step3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our first step is to add an interface that defines the methods common to all of the injected objects. In the case of our logging classes, each share a single common method <code>println()</code>. It is a convention to begin interface names with an "I", we&#8217;ll call our interface ILog.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">namespace Example\Log;

interface ILog {
	public function println($line, $emphasis);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once defined, we can tell our logging classes that they must adhere to the interface by using the <code>implements</code> keyword.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">namespace Example\Log;
use Example\Log\ILog;

class Console implements ILog {
	...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This guarantees that <code>Example\Log\Console</code> provides a <code>println()</code> method (if it doesn&#8217;t PHP will error out when the class is loaded). Our last step is to enforce some type safety by adding type hinting to the <code>Captain</code> constructor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">class Captain {
    /**
     * @var ILog
     */
    private $captainsLog;
    public function __construct(ILog $log){
            $this-&gt;captainsLog = $log;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This makes <code>__construct</code> check that the injected <code>$log</code> object belongs to the hinted class (or interface) and will cause an error if it doesn&#8217;t. Conforming our injected dependencies to a well defined interface in this way has two primary benefits: it makes code easier to read and understand because the interface outlines exactly how a resource was designed to be used, and it makes code easier to safely modify, as PHP will loudly warn you if you have broken the contract set by the interface.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_testing">4. Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far we&#8217;ve seen how dependency injection can help us write cleaner, easier to read code, that has less duplication and is easier to change. But we have yet to touch on how DI can make your tests better. Since that was the hook of the entire presentation, let&#8217;s get down to it. We&#8217;ll start with some test scaffolding for the <code>Captain</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh"># Switch to version of code with interface implemented and test scaffolding added, ready for test writing
git checkout -f step4</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll be using <a href="http://phpunit.de/">PHPUnit</a> to run our tests. <a href="http://phpunit.de/getting-started.html">Installation is easy</a>. In the new tests directory I&#8217;ve added a phpunit.xml to tell PHPUnit how to run our tests. I&#8217;ve also added our first test.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">use Example\Starfleet\Captain;
use Example\Log\Console;

class CaptainTest extends PHPUnit_Framework_TestCase {

	public function test_issueCommand_returns_string() {
		$cap = new Captain(new Console());
		$command = $cap-&gt;issueCommand();

		$this-&gt;assertInternalType('string', $command);
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This tests that <code>issueCommand()</code> returns a string. To run our test suite, do the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh"># enter test dir
cd tests
# run all tests
phpunit</code></pre>
</div>
</div>
<div class="paragraph">
<p>But, oops, it fails. That&#8217;s because when I added the test scaffolding I also snuck a change into our logging classes. Now <code>println()</code> requires special environmental permissions that we (the dev user) don&#8217;t have. This is a fairly common scenario; our dependencies are external resources that we can&#8217;t always interact with the same way. Resources may require special permissions, touch sensitive data, or simply be unreliable. Dependency injection allows us to work around this issue by injecting different resources appropriate in different scenarios. In the case of testing we will want to inject resources that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Don&#8217;t require any external input (which may be unreliable or unavailable)</p>
</li>
<li>
<p>Don&#8217;t generate any external output (which is hard to test)</p>
</li>
<li>
<p>Respond as quickly as possible (to allow us to run our tests as frequently and as fast as possible)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>PHPUnit provides a method for creating 'Mock Objects' which meet all of the above requirements. Here&#8217;s how we could get our test passing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">public function test_issueCommand_returns_string(){
	$mockLog = $this-&gt;getMockBuilder('Example\Log\ILog')
		-&gt;setMethods(array('println'))
		-&gt;getMock();

	$cap = new Captain($mockLog);
	$command = $cap-&gt;issueCommand();

	$this-&gt;assertInternalType('string', $command);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The call to <code>getMockBuilder()</code> provides a fluent interface that we can use to assign attributes to our mock object. We start with an empty mock class that can be passed around like an implementation of the ILog interface. Next, we tell the mock which methods will be called during this test using <code>setMethods()</code>. Finally we call <code>getMock()</code> to return the actual mock object to be injected.</p>
</div>
<div class="paragraph">
<p>This gets us to a decent black box test, but we would like to go further and assert that our dependency is being used in the way that we expected. PHPUnit gives us a way to do this using the <code>expects()</code> method of the mock object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">public function test_issueCommand_returns_string(){
	$mockLog = $this-&gt;getMockBuilder('Example\Log\ILog')
		-&gt;setMethods(array('println'))
		-&gt;getMock();
	$mockLog-&gt;expects($this-&gt;at(0))
		-&gt;method('println')
		-&gt;with($this-&gt;matchesRegularExpression('/Captain\'s Log, Stardate [\d\.]+/'), $this-&gt;equalTo(true));
	$mockLog-&gt;expects($this-&gt;at(1))
		-&gt;method('println')
		-&gt;with($this-&gt;isType('string'));

	$cap = new Captain($mockLog);
	$command = $cap-&gt;issueCommand();

	$this-&gt;assertInternalType('string', $command);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This isn&#8217;t the most straightforward example of testing mock expectations, but it does illustrate the flexibility PHPUnit can provide to maximize your test coverage. As you can see, we&#8217;re calling <code>expects()</code> twice to set an expectation for both calls made to the method <code>println()</code> (the first: <code>$this&#8594;at(0)</code>, and the second: <code>$this&#8594;at(1)</code>). The <code>with()</code> method allows us to describe the expected values of the parameters being passed to <code>println()</code>. For the first call we expect to be printing the stardate, but we&#8217;re not exactly sure what the stardate will be at the time the test is run, so we use a regular expression to check the string looks sane regardless of the actual time. We also expect that the first call will have a second parameter equal to <code>true</code> so we add a second matcher to our call to <code>with()</code>. For the second call, our only expectation is that <code>println</code> will get called with a string, which we can assert with <code>with($this&#8594;isType('string')</code></p>
</div>
<div class="paragraph">
<p>By using dependency injection and mock objects we&#8217;ve gone from not being able to test our <code>Captain</code> class at all to fairly complete test coverage, with relativity little effort. Better yet, the test is easy to run and understand, and depends on no environmental settings or automagic bootstrapping. A mock object may be taken one step further by using the <code>will()</code> method to force the mock to return expected values (presumably to be used by assertions downstream), this modification is left as an exercise for the reader.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh"># Switch to final version of code with first test complete
git checkout -f step4a</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>I wrote this post and the accompanying demo for a hands-on presentation. <a href="/artifacts/di101_slides.html">Here are the slides for that presentation.</a></em></p>
</div>
</div>
</div>

    </div>
  </div>
</section>
<section class="section">
  <div class="container has-text-centered">
    <p></p>
  </div>
</section>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
